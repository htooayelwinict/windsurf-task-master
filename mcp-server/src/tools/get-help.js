import { z } from 'zod';
import { createErrorHandler } from '../utils/errors.js';
import { logger } from '../utils/logger.js';

/**
 * Contextual help system that provides situation-specific guidance
 */
export function registerGetHelpTool(server, taskManager) {
    server.addTool({
        name: 'get_help',
        description: 'Get contextual help and workflow guidance for efficient task management',
        parameters: z.object({
            situation: z.enum([
                'starting-new-project',
                'task-too-big', 
                'stuck-on-task',
                'project-status',
                'best-practices',
                'task-hierarchy'
            ]).describe('What situation you need help with'),
            projectId: z.string().optional().describe('Project ID for context-specific help')
        }),
        execute: async (args) => {
            const errorHandler = createErrorHandler('get_help');
            try {
                let helpContent = getHelpContent(args.situation);
                
                // Add project-specific context if projectId is provided
                if (args.projectId) {
                    const projectContext = await getProjectContext(taskManager, args.projectId);
                    helpContent += projectContext;
                }
                
                return {
                    content: [{
                        type: 'text',
                        text: helpContent
                    }]
                };
            } catch (error) {
                return errorHandler(error, args);
            }
        }
    });
}

/**
 * Get help content based on situation
 * @param {string} situation - The situation the user needs help with
 * @returns {string} Formatted help content
 */
function getHelpContent(situation) {
    const helpTexts = {
        'task-hierarchy': `
üèóÔ∏è **Task Hierarchy - Avoiding the Turtleneck Pattern:**

**What is the turtleneck pattern?**
‚Ä¢ One giant parent task with many subtasks
‚Ä¢ Creates bottlenecks in workflow
‚Ä¢ Poor visibility of progress across domains
‚Ä¢ Difficult to parallelize work

**Benefits of balanced task hierarchy:**
‚Ä¢ Multiple parent tasks organized by domain (backend, frontend, etc.)
‚Ä¢ Better progress visibility across project areas
‚Ä¢ Easier to work on multiple areas simultaneously
‚Ä¢ Clearer dependencies between functional domains
‚Ä¢ Matches real development workflows

**How to create balanced task structure:**
1. Use the suggest_project_structure tool to analyze your project
2. Review the suggested structure
3. Create the structure automatically or manually
4. Assign tasks to appropriate team members

**Commands:**
‚Ä¢ Analyze only: \`mcp1_suggest_project_structure({description: "...", projectId: "...", structureOnly: true})\`
‚Ä¢ Create structure: \`mcp1_suggest_project_structure({description: "...", projectId: "...", autoCreate: true})\`
`,
        'starting-new-project': `
üöÄ **Starting a New Project - Quick Guide:**

**Step 1: Create Foundation Tasks**
‚Ä¢ Project setup and configuration
‚Ä¢ Environment setup (dependencies, tools)
‚Ä¢ Basic structure/scaffolding

**Step 2: Plan Task Structure**
‚Ä¢ Break down by functional areas
‚Ä¢ Set clear dependencies
‚Ä¢ Prioritize critical path items

**Step 3: Assign Initial Tasks**
‚Ä¢ Start with setup/configuration
‚Ä¢ Use Windsurf for automation tasks
‚Ä¢ Track progress with status updates

**Commands:**
\`\`\`
// Create project with balanced structure
mcp1_suggest_project_structure({
  description: "Detailed project description",
  projectId: "your-project-id",
  autoCreate: true
})

// Assign first task to Windsurf
mcp1_assign_to_windsurf({
  id: 1, 
  projectId: "your-project-id"
})

// Check progress
mcp1_display_task_status({
  projectId: "your-project-id"
})
\`\`\`

**Pro Tip:** The system now auto-suggests priorities and acceptance criteria!`,

        'task-too-big': `
üìè **Task Too Large? Break It Down:**

**Signs a task is too big:**
‚Ä¢ Implementation would take more than a few hours
‚Ä¢ Requires work across multiple domains (frontend, backend, etc.)
‚Ä¢ Has many distinct acceptance criteria
‚Ä¢ Feels overwhelming or unclear where to start
‚Ä¢ Shows a "turtleneck pattern" with too many subtasks

**How to break it down:**
1. Use the suggest_project_structure tool to analyze and create a balanced hierarchy
2. Create multiple parent tasks organized by domain (backend, frontend, etc.)
3. Make each subtask focused on a single goal
4. Add clear acceptance criteria to each subtask
5. Prioritize subtasks and set dependencies

**Commands:**
‚Ä¢ Analyze project: \`mcp1_suggest_project_structure({description: "...", projectId: "..."})\`
‚Ä¢ Create balanced structure: \`mcp1_suggest_project_structure({description: "...", projectId: "...", autoCreate: true})\`
‚Ä¢ Add subtask manually: \`mcp1_add_subtask({title: "...", description: "...", parentTaskId: 1, projectId: "..."})\`
‚Ä¢ Update task: \`mcp1_update_task({id: 1, description: "Updated description", projectId: "..."})\`

**See also:** Use \`mcp1_get_help({situation: "task-hierarchy", projectId: "..."})\` for detailed guidance on balanced task structures.
`,

        'stuck-on-task': `
üîß **Stuck on a Task? Try These:**

**1. Check Dependencies**
‚Ä¢ Are prerequisite tasks actually complete?
‚Ä¢ Do you have all required information?

**2. Break Down Further**
‚Ä¢ Is the task still too large/complex?
‚Ä¢ Can you create smaller subtasks?

**3. Reassign or Get Help**
‚Ä¢ Is this task better suited for someone else?
‚Ä¢ Would pair programming help?

**4. Document Blockers**
‚Ä¢ Update task description with blockers
‚Ä¢ Add comments about attempted solutions

**Commands:**
\`\`\`
// Add subtask for smaller piece
mcp1_add_subtask({
  parentTaskId: 5,
  title: "Specific part I can complete",
  projectId: "your-project"
})

// Document a blocker
mcp1_update_task({
  id: 5,
  description: "Original description\\n\\nBLOCKER: Specific issue...",
  projectId: "your-project"
})
\`\`\``,

        'project-status': `
üìä **Project Status & Progress:**

**Key Metrics:**
‚Ä¢ Completion rate (tasks completed / total)
‚Ä¢ Tasks by status (pending, in-progress, completed)
‚Ä¢ Tasks by assignee (you, Windsurf, unassigned)
‚Ä¢ Blocked tasks and dependencies

**Visualizing Progress:**
‚Ä¢ Use display_task_status for overview
‚Ä¢ Check subtask completion for complex tasks
‚Ä¢ Review task dependencies for bottlenecks

**Commands:**
\`\`\`
// Get full project status
mcp1_display_task_status({
  projectId: "your-project"
})

// List tasks by status
mcp1_list_tasks({
  projectId: "your-project",
  status: "in-progress" // or "pending", "completed", "all"
})

// Check tasks assigned to Windsurf
mcp1_get_windsurf_tasks({
  projectId: "your-project"
})
\`\`\``,

        'best-practices': `
‚ú® **Task Management Best Practices:**

**Task Creation:**
‚Ä¢ Use clear, action-oriented titles
‚Ä¢ Include specific acceptance criteria
‚Ä¢ Set realistic priorities
‚Ä¢ Establish proper dependencies

**Task Workflow:**
‚Ä¢ Update progress regularly
‚Ä¢ Only mark 100% when completely done
‚Ä¢ Document blockers and solutions

**Workflow Optimization:**
‚Ä¢ Work on high-priority tasks first
‚Ä¢ Complete dependencies before dependent tasks
‚Ä¢ Use subtasks for complex features
‚Ä¢ Let the system auto-cleanup and organize

**Balanced Task Structure:**
‚Ä¢ Create multiple parent tasks by domain
‚Ä¢ Avoid the "turtleneck pattern" (one parent with many subtasks)
‚Ä¢ Use suggest_project_structure for optimal organization
‚Ä¢ See \`mcp1_get_help({situation: "task-hierarchy"})\` for more details
`
    };

    return helpTexts[situation] || 'Help topic not found. Available topics: starting-new-project, task-too-big, stuck-on-task, project-status, best-practices, task-hierarchy';
}

/**
 * Get project-specific context for help content
 * @param {Object} taskManager - Task manager instance
 * @param {string} projectId - Project ID
 * @returns {string} Project-specific context
 */
async function getProjectContext(taskManager, projectId) {
    try {
        // Check if project exists by trying to get its tasks
        const tasks = await taskManager.listTasks(projectId);
        
        if (!tasks || tasks.length === 0) {
            return `\n\nüìÅ **Project "${projectId}":** No tasks found. This might be a new project!`;
        }

        const completed = tasks.filter(t => t.status === 'completed').length;
        const inProgress = tasks.filter(t => t.status === 'in-progress').length;
        const pending = tasks.filter(t => t.status === 'pending').length;
        const total = tasks.length;
        const completionRate = Math.round((completed / total) * 100);

        const windsurfTasks = tasks.filter(t => t.assignedTo === 'windsurf');

        let context = `\n\nüìÅ **Your Project "${projectId}" Status:**`;
        context += `\n‚Ä¢ Progress: ${completed}/${total} tasks completed (${completionRate}%)`;
        context += `\n‚Ä¢ Active: ${inProgress} in-progress, ${pending} pending`;

        if (windsurfTasks.length > 0) {
            context += `\n‚Ä¢ Windsurf assigned: ${windsurfTasks.length} tasks`;
            const activeWindsurf = windsurfTasks.filter(t => t.status === 'in-progress');
            if (activeWindsurf.length > 0) {
                context += `\n‚Ä¢ Currently working on: "${activeWindsurf[0].title}"`;
            }
        }

        // Suggestions based on project state
        if (completionRate === 0) {
            context += `\n\nüí° **Suggestion:** Start by assigning a task to Windsurf!`;
        } else if (completionRate > 80) {
            context += `\n\nüéâ **Great progress!** Consider cleaning up with: \`mcp1_cleanup_tasks({projectId: "${projectId}"})\``;
        } else if (inProgress === 0 && pending > 0) {
            context += `\n\n‚è≥ **Ready to work:** Assign a pending task to continue progress.`;
        }

        // Check for turtleneck pattern
        const parentTasks = tasks.filter(t => !t.isSubtask);
        if (parentTasks.length === 1 && tasks.length > 4) {
            context += `\n\n‚ö†Ô∏è **Turtleneck Pattern Detected:** This project has a single parent task with multiple subtasks.`;
            context += `\nüí° **Suggestion:** Consider using \`mcp1_suggest_project_structure({description: "...", projectId: "${projectId}", autoCreate: true})\` to create a more balanced task hierarchy.`;
        }

        return context;

    } catch (error) {
        logger.error('Error getting project context:', error);
        return `\n\nüìÅ **Project "${projectId}":** Unable to load project context.`;
    }
}